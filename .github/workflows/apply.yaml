# SynergyMesh Governance Pipeline - Eight Stage Apply Workflow
# å…«éšæ®µæ²»ç†ç®¡ç·š - Apply å·¥ä½œæµ
#
# This workflow implements the full governance pipeline:
# Stage 1: Lint - èªæ³•æª¢æŸ¥
# Stage 2: Format - æ ¼å¼è¦ç¯„
# Stage 3: Schema - çµæ§‹é©—è­‰
# Stage 4: Vector Test - å‘é‡æ¸¬è©¦
# Stage 5: Policy Gate - ç­–ç•¥é–˜
# Stage 6: SBOM - ä¾›æ‡‰éˆæ¸…å–®
# Stage 7: Provenance - æº¯æºæ³¨å…¥
# Stage 8: Audit - å¯©è¨ˆè¨˜éŒ„

name: Governance Pipeline (Apply)

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'governance/**'
      - 'schemas/**'
      - 'tools/docs/**'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'governance/**'
      - 'schemas/**'
      - 'tools/docs/**'
  workflow_dispatch:
    inputs:
      skip_stages:
        description: 'Stages to skip (comma-separated: lint,format,schema,vector,policy,sbom,provenance,audit)'
        required: false
        default: ''
      dry_run:
        description: 'Dry run mode (no changes committed)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ==========================================================================
  # Stage 1: Lint - èªæ³•æª¢æŸ¥
  # ==========================================================================
  stage-1-lint:
    name: "Stage 1: Lint"
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.lint.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install yamllint pyyaml jsonschema
      
      - name: Run YAML Lint
        id: lint
        run: |
          echo "ğŸ” Stage 1: Lint - èªæ³•æª¢æŸ¥"
          echo "================================"
          
          # Find and lint YAML files
          find docs governance -name "*.yaml" -o -name "*.yml" | head -20 | while read file; do
            echo "Checking: $file"
            yamllint -d relaxed "$file" || echo "Warning: $file has lint issues"
          done
          
          echo "âœ… Lint stage completed"

  # ==========================================================================
  # Stage 2: Format - æ ¼å¼è¦ç¯„
  # ==========================================================================
  stage-2-format:
    name: "Stage 2: Format"
    runs-on: ubuntu-latest
    needs: stage-1-lint
    outputs:
      status: ${{ steps.format.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Format
        id: format
        run: |
          echo "ğŸ“ Stage 2: Format - æ ¼å¼è¦ç¯„"
          echo "================================"
          
          # Check indentation and formatting
          errors=0
          for file in docs/*.yaml docs/*.json governance/**/*.yaml; do
            if [ -f "$file" ]; then
              # Check for tabs (should use spaces)
              if grep -P '\t' "$file" > /dev/null 2>&1; then
                echo "Warning: $file contains tabs"
                ((errors++))
              fi
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "âš ï¸ Found $errors formatting issues"
          else
            echo "âœ… Format stage completed"
          fi

  # ==========================================================================
  # Stage 3: Schema - çµæ§‹é©—è­‰
  # ==========================================================================
  stage-3-schema:
    name: "Stage 3: Schema Validation"
    runs-on: ubuntu-latest
    needs: stage-2-format
    outputs:
      status: ${{ steps.schema.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pyyaml jsonschema
      
      - name: Validate Schema
        id: schema
        run: |
          echo "ğŸ“‹ Stage 3: Schema - çµæ§‹é©—è­‰"
          echo "================================"
          
          python tools/docs/validate_index.py --verbose
          
          echo "âœ… Schema validation completed"

  # ==========================================================================
  # Stage 4: Vector Test - å‘é‡æ¸¬è©¦
  # ==========================================================================
  stage-4-vector:
    name: "Stage 4: Vector Tests"
    runs-on: ubuntu-latest
    needs: stage-3-schema
    outputs:
      status: ${{ steps.vector.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pyyaml jsonschema
      
      - name: Run Vector Tests
        id: vector
        run: |
          echo "ğŸ§ª Stage 4: Vector Test - å‘é‡æ¸¬è©¦"
          echo "================================"
          
          # Run test vectors if they exist
          if [ -d "test-vectors" ]; then
            python tools/utilities/validate_yaml.py || echo "Vector tests completed with warnings"
          else
            echo "No test vectors found, skipping"
          fi
          
          echo "âœ… Vector test stage completed"

  # ==========================================================================
  # Stage 5: Policy Gate - ç­–ç•¥é–˜
  # ==========================================================================
  stage-5-policy:
    name: "Stage 5: Policy Gate"
    runs-on: ubuntu-latest
    needs: stage-4-vector
    outputs:
      status: ${{ steps.policy.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Policy Compliance
        id: policy
        run: |
          echo "ğŸš§ Stage 5: Policy Gate - ç­–ç•¥é–˜"
          echo "================================"
          
          # Check if base policy exists
          if [ -f "governance/policies/base-policy.yaml" ]; then
            echo "âœ… Base policy found"
            
            # Validate policy structure
            python3 -c "
import yaml
with open('governance/policies/base-policy.yaml', 'r') as f:
    policy = yaml.safe_load(f)
    
required = ['validation', 'rules', 'autofix', 'audit', 'supplyChain']
for req in required:
    if req in policy:
        print(f'âœ… {req}: configured')
    else:
        print(f'âš ï¸ {req}: missing')
"
          else
            echo "âš ï¸ Base policy not found"
          fi
          
          echo "âœ… Policy gate stage completed"

  # ==========================================================================
  # Stage 6: SBOM - ä¾›æ‡‰éˆæ¸…å–®
  # ==========================================================================
  stage-6-sbom:
    name: "Stage 6: SBOM Generation"
    runs-on: ubuntu-latest
    needs: stage-5-policy
    outputs:
      status: ${{ steps.sbom.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Generate SBOM
        id: sbom
        run: |
          echo "ğŸ“¦ Stage 6: SBOM - ä¾›æ‡‰éˆæ¸…å–®"
          echo "================================"
          
          # Check existing SBOM
          if [ -f "governance/sbom/synergymesh.spdx.json" ]; then
            echo "âœ… SBOM exists: governance/sbom/synergymesh.spdx.json"
            
            # Validate SBOM structure
            python3 -c "
import json
with open('governance/sbom/synergymesh.spdx.json', 'r') as f:
    sbom = json.load(f)
    
print(f'SPDX Version: {sbom.get(\"spdxVersion\", \"unknown\")}')
print(f'Packages: {len(sbom.get(\"packages\", []))}')
print(f'Relationships: {len(sbom.get(\"relationships\", []))}')
"
          else
            echo "âš ï¸ SBOM not found, generating..."
            python tools/docs/provenance_injector.py --generate-sbom || echo "SBOM generation skipped"
          fi
          
          echo "âœ… SBOM stage completed"

  # ==========================================================================
  # Stage 7: Provenance - æº¯æºæ³¨å…¥
  # ==========================================================================
  stage-7-provenance:
    name: "Stage 7: Provenance Injection"
    runs-on: ubuntu-latest
    needs: stage-6-sbom
    outputs:
      status: ${{ steps.provenance.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Generate Provenance
        id: provenance
        run: |
          echo "ğŸ” Stage 7: Provenance - æº¯æºæ³¨å…¥"
          echo "================================"
          
          # Check existing provenance
          if [ -f "governance/sbom/provenance.json" ]; then
            echo "âœ… Provenance exists: governance/sbom/provenance.json"
            
            # Validate provenance structure
            python3 -c "
import json
with open('governance/sbom/provenance.json', 'r') as f:
    prov = json.load(f)
    
print(f'Schema: {prov.get(\"\$schema\", \"unknown\")}')
print(f'Type: {prov.get(\"_type\", \"unknown\")}')
subjects = prov.get('subject', [])
print(f'Subjects: {len(subjects)}')
"
          else
            echo "âš ï¸ Provenance not found, generating..."
            python tools/docs/provenance_injector.py --generate-provenance || echo "Provenance generation skipped"
          fi
          
          echo "âœ… Provenance stage completed"

  # ==========================================================================
  # Stage 8: Audit - å¯©è¨ˆè¨˜éŒ„
  # ==========================================================================
  stage-8-audit:
    name: "Stage 8: Audit Recording"
    runs-on: ubuntu-latest
    needs: stage-7-provenance
    outputs:
      status: ${{ steps.audit.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Generate Audit Record
        id: audit
        run: |
          echo "ğŸ“ Stage 8: Audit - å¯©è¨ˆè¨˜éŒ„"
          echo "================================"
          
          # Generate audit event
          python tools/docs/provenance_injector.py --audit || echo "Audit recording skipped"
          
          # Summary
          echo ""
          echo "ğŸ“Š Pipeline Summary"
          echo "==================="
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          
          echo ""
          echo "âœ… Audit stage completed"

  # ==========================================================================
  # Summary Job
  # ==========================================================================
  summary:
    name: "Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [stage-1-lint, stage-2-format, stage-3-schema, stage-4-vector, stage-5-policy, stage-6-sbom, stage-7-provenance, stage-8-audit]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "# ğŸ Governance Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Name | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Lint | ${{ needs.stage-1-lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Format | ${{ needs.stage-2-format.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Schema | ${{ needs.stage-3-schema.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | Vector Test | ${{ needs.stage-4-vector.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | Policy Gate | ${{ needs.stage-5-policy.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 6 | SBOM | ${{ needs.stage-6-sbom.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 7 | Provenance | ${{ needs.stage-7-provenance.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 8 | Audit | ${{ needs.stage-8-audit.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              lint: '${{ needs.stage-1-lint.result }}',
              format: '${{ needs.stage-2-format.result }}',
              schema: '${{ needs.stage-3-schema.result }}',
              vector: '${{ needs.stage-4-vector.result }}',
              policy: '${{ needs.stage-5-policy.result }}',
              sbom: '${{ needs.stage-6-sbom.result }}',
              provenance: '${{ needs.stage-7-provenance.result }}',
              audit: '${{ needs.stage-8-audit.result }}'
            };
            
            const allPassed = Object.values(results).every(r => r === 'success');
            const emoji = allPassed ? 'âœ…' : 'âš ï¸';
            
            let body = `## ${emoji} Governance Pipeline Results\n\n`;
            body += '| Stage | Status |\n';
            body += '|-------|--------|\n';
            body += `| 1. Lint | ${results.lint === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            body += `| 2. Format | ${results.format === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            body += `| 3. Schema | ${results.schema === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            body += `| 4. Vector Test | ${results.vector === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            body += `| 5. Policy Gate | ${results.policy === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            body += `| 6. SBOM | ${results.sbom === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            body += `| 7. Provenance | ${results.provenance === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            body += `| 8. Audit | ${results.audit === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            
            if (allPassed) {
              body += '\n**All governance checks passed!** ğŸ‰';
            } else {
              body += '\n**Some governance checks failed.** Please review the workflow logs.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
