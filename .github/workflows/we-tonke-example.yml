---
# Example workflow demonstrating WE_TONKE environment variable usage
# This workflow shows how to securely inject and use the WE_TONKE secret in CI/CD
#
# Prerequisites:
# 1. Create a repository secret named WE_TONKE in GitHub Settings:
#    - Go to Settings -> Security -> Secrets and variables -> Actions
#    - Click "New repository secret"
#    - Name: WE_TONKE
#    - Value: Your token value
#
# For Codespaces:
# 1. Go to your GitHub profile Settings -> Codespaces -> Secrets
# 2. Add WE_TONKE secret and select repositories to apply
#
# For local development:
# - macOS/Linux: export WE_TONKE="your_token"
# - Windows PowerShell: $env:WE_TONKE = "your_token"

name: WE_TONKE Example

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug output (shows token length only)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  example-usage:
    name: ðŸ“‹ WE_TONKE Example Usage
    runs-on: ubuntu-latest

    env:
      # Inject WE_TONKE from repository secrets
      WE_TONKE: ${{ secrets.WE_TONKE }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'core/contracts/contracts-L1/contracts/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        working-directory: core/contracts/contracts-L1/contracts
        run: npm ci

      - name: ðŸ” Validate WE_TONKE (debug only - shows length, not value)
        if: ${{ github.event.inputs.debug == 'true' }}
        run: |
          echo "WE_TONKE validation:"
          if [ -n "$WE_TONKE" ]; then
            echo "âœ… WE_TONKE is set"
            echo "ðŸ“ Length: ${#WE_TONKE} characters"
          else
            echo "âŒ WE_TONKE is NOT set"
            echo "Please add WE_TONKE to repository secrets"
            exit 1
          fi

      - name: ðŸ§ª Run tests with WE_TONKE available
        working-directory: core/contracts/contracts-L1/contracts
        run: npm test

      - name: ðŸ“Š Example: Use WE_TONKE via utility function
        working-directory: core/contracts/contracts-L1/contracts
        run: |
          # Build the project first to use the compiled utility
          npm run build
          
          # Use the actual utility function via ts-node
          npx tsx -e "
            import { getOptionalEnv, getWeTonke } from './src/config/env';
            
            // Safe way to check if WE_TONKE is configured
            const tokenValue = getOptionalEnv('WE_TONKE');
            
            if (tokenValue) {
              // In production, use getWeTonke() which throws if not set
              const token = getWeTonke();
              console.log('âœ… WE_TONKE is accessible via getWeTonke()');
              console.log('ðŸ“ Token length:', token.length);
              // Never log the actual token value!
            } else {
              console.log('âš ï¸ WE_TONKE is not set - this is expected if secret is not configured');
              console.log('ðŸ’¡ Add WE_TONKE to repository secrets to use this feature');
            }
          "

      - name: ðŸ“ Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ”‘ WE_TONKE Configuration Guide
          
          ### Repository Secrets (for GitHub Actions)
          1. Go to **Settings** â†’ **Security** â†’ **Secrets and variables** â†’ **Actions**
          2. Click **New repository secret**
          3. Name: `WE_TONKE`
          4. Value: Your token
          
          ### Codespaces Secrets
          1. Go to **GitHub Profile Settings** â†’ **Codespaces** â†’ **Secrets**
          2. Add `WE_TONKE` and select target repositories
          
          ### Local Development
          ```bash
          # macOS/Linux
          export WE_TONKE="your_token"
          
          # Windows PowerShell
          $env:WE_TONKE = "your_token"
          ```
          
          ### Usage in TypeScript
          ```typescript
          import { getWeTonke } from './config/env';
          
          // Fail-fast: throws if WE_TONKE is not set
          const token = getWeTonke();
          ```
          
          EOF
